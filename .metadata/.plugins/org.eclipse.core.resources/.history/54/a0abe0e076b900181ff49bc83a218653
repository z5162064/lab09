package dungeon_game;

public class Map {
	private int mapsize; // map is a square, this is the side length 
	private MapTile[][] map;
	private String command; //the input from the user (assume it is "up", "down", "left", or "right")
	private boolean enemywincondition;
	private boolean treasurewincondition;
	private boolean boulderwincondition;
	private String gamestatus = "In-Progress";
	
	public Map(int size) {
		this.mapsize = size;
		map = new MapTile[size][size];
		this.addTiles(); // creates MapTile objects and puts Walls on edges
		this.addNeighbours(); //gives each tile the reference to adjacent MapTiles
	}
	
	// adds walls to all MapTiles on the edge of the 2d array
	private void addTiles() {
		for (int i = 0; i < mapsize; i++) {
			for (int j = 0; j < mapsize; j++) {
				map[i][j] = new MapTile(i, j);
				if (i == 0 || j ==0 || i == mapsize-1 || j == mapsize-1) {
					Terrain w = new Wall(map[i][j]);
					map[i][j].addEntity(w);
				}
			}
		}
	}
	public boolean checkSwitches() {//Returns true if there are no switches or if all switches are triggered
		boolean isThereSwitches =  false;
		for (int i = 0; i < mapsize; i++) {
			for (int j = 0; j < mapsize; j++) {
				if (map[i][j].FWCheck()) {
					isThereSwitches = true;
					if (!map[i][j].isTriggered()) {
						return false;
					}
				}
			}
		}
		return isThereSwitches;
	}
	public void setWinConditions(boolean enemy, boolean treasure, boolean boulder) {
		this.enemywincondition = enemy;
		this.treasurewincondition = treasure;
		this.boulderwincondition = boulder;
	}
	public boolean checkEnemies() {
		for (int i = 0; i < mapsize; i++) {
			for (int j = 0; j < mapsize; j++) {
				if (map[i][j].hasEnemy()) {
					return false;
				}
			}
		}
		return true;
	}
	public boolean checkTreasure() {
		for (int i = 0; i < mapsize; i++) {
			for (int j = 0; j < mapsize; j++) {
				if (map[i][j].TreasureCheck()) {
					return false;
				}
			}
		}
		return true;
	}
	public boolean checkWinConditions() {
		boolean ewc = true;
		boolean twc = true;
		boolean bwc = true;
		if (enemywincondition == true) {
			ewc = false;
			ewc = checkEnemies();
		}
		if (treasurewincondition == true) {
			twc = false;
			twc = checkTreasure();
		}
		if (boulderwincondition == true) {
			bwc = false;
			bwc = checkSwitches();
		}
		if (bwc && twc && ewc) {
			return true;
		}
		else {
			return false;
		}
	}
	// adds references for adjacent tiles to each other
	private void addNeighbours() {
		for (int i = 0; i < mapsize; i++) {
			for (int j = 0; j < mapsize; j++) {
				if (i > 0)
					map[i][j].setUp(map[i-1][j]);
				if (i < mapsize-1)
					map[i][j].setDown(map[i+1][j]);
				if (j > 0)
					map[i][j].setLeft(map[i][j-1]);
				if (j < mapsize-1)
					map[i][j].setRight(map[i][j+1]);
			}
		}
	}
	
	// takes object then calls MapTiles to move them
	// objects passed in should have method named 'move' that returns a String ("up", "down", "right", "left")
	public void MoveEntity(Object o, MapTile from, String command) {
	    if (o instanceof PlayerCharacter) {
	    	if (command=="up") {
	    		if (from.getUp().ExitCheck()) {
	    			System.out.print("You have exited and won. \n");
	    		}
	    		if (from.getUp().BoulderCheck() && from.getUp().canMoveUp(o)) {
	    			from.getUp().MoveUp(from.getUp().get_boulder());
	    			from.MoveUp(o);
	    			from.getUp().triggerSwitch();
	    		}

	    		else if (from.getUp().PitCheck()) {// we can add hover potion stuff here
	    			System.out.print("You have died.\n");
	    		}
	    		else if (from.canMoveUp(o)) {
		    		from.MoveUp(o);
		    		
	    		}

	    	}
	    	if (command=="left") {
	    		if (from.getLeft().ExitCheck()) {
	    			System.out.print("You have exited and won. \n");
	    		}
	    		if (from.getLeft().BoulderCheck() && from.getLeft().canMoveLeft(o)) {
	    			from.getLeft().MoveLeft(from.getLeft().get_boulder());
	    			from.MoveLeft(o);
	    			from.getLeft().triggerSwitch();
	    		}
	    		else if (from.getLeft().PitCheck()) {
	    			System.out.print("You have died.\n");
	    		}
	    		else if (from.canMoveLeft(o)) {
		    		from.MoveLeft(o);
	    		}

	    	}
	    	if (command=="right") {
	    		if (from.getRight().ExitCheck()) {
	    			System.out.print("You have exited and won. \n");
	    		}
	    		if (from.getRight().BoulderCheck() && from.getRight().canMoveRight(o)) {
	    			from.getRight().MoveRight(from.getRight().get_boulder());
	    			from.MoveRight(o);
	    			from.getRight().getRight().triggerSwitch();
	    		}
	    		else if (from.getRight().PitCheck()) {
	    			System.out.print("You have died.\n");
	    		}
	    		
	    		else if (from.canMoveRight(o)) {
		    		from.MoveRight(o);
	    		}

	    	}
	    	if (command=="down") {
	    		if (from.getDown().ExitCheck()) {
	    			System.out.print("You have exited and won. \n");
	    		}
	    		if (from.getDown().BoulderCheck() && from.getDown().canMoveDown(o)) {
	    			from.getDown().MoveDown(from.getDown().get_boulder());
	    			from.MoveDown(o);
	    			from.getDown().triggerSwitch();
	    		}
	    		else if (from.getDown().PitCheck()) {
	    			System.out.print("You have died.\n");
	    		}
	    		
	    		else if (from.canMoveDown(o)) {
		    		from.MoveDown(o);
	    		}

	    	}
	    	checkWinConditions();
	    }
	}
	private String getCommand() {
		return this.command;
	}
	
	public MapTile get_maptile(int i,int j) {
		return map[i][j];
	}
	
	
	
	// for early troubleshooting
	public void printOnTerminal() {
		boolean flag = false;
		for (int i = 0; i < mapsize; i++) {
			for (int j = 0; j < mapsize; j++) {
				String identifier = "";
				if (map[i][j].hasPlayer())
					identifier += "C";
					flag = true;
					//System.out.print("C ");
				if (map[i][j].BoulderCheck()) {
					identifier += "B";
					flag = true;
					//System.out.print("B ");
				}
				if (map[i][j].ExitCheck()) {
					flag = true;
					identifier += "E";
					//System.out.print("E ");
				}
				if (map[i][j].FWCheck()) {
					flag = true;
					identifier += "S";
					//System.out.print("F ");
				}
				if (map[i][j].TreasureCheck()) {
					identifier += "T";
				}
				if (map[i][j].isPassable()) { //Normal floor
					identifier += "N";
				}
					//System.out.print("T ");
				if (map[i][j].WallCheck()) {
					System.out.print("W");//Wall
				}
				System.out.print(identifier + " ");
				flag = false;
				
			}
			System.out.print("\n");
		}
	}
	
	// main function only for early testing and debugging
	public static void main(String[] args) {
//		Map m = new Map(8);
//		//System.out.println(m.mapsize);
//		PlayerCharacter p = new PlayerCharacter();
//		m.map[6][6].addEntity(p);
//		
//		m.MoveEntity(p, m.get_maptile(5, 6), "up");
//		m.printOnTerminal();
//		m.MoveEntity(p,m.map[6][6],"down");
//		m.printOnTerminal();
		Map m = new Map(20);
		m.setWinConditions(false, true, true);
		PlayerCharacter player = new PlayerCharacter();
		m.get_maptile(5,4).addEntity(player);
		Boulder boulder = new Boulder(m.get_maptile(5, 5));
		m.get_maptile(5, 5).addEntity(boulder);
		FloorSwitch floorswitch = new FloorSwitch(m.get_maptile(5, 6));		
		m.get_maptile(5, 6).addEntity(floorswitch);
		Treasure treasure = new Treasure(100);
		m.get_maptile(4, 5).addEntity(treasure);
		m.printOnTerminal();
		m.MoveEntity(player, player.get_MapTile(), "right");
		m.MoveEntity(player, player.get_MapTile(), "down");
		m.printOnTerminal();

	}
	
}
